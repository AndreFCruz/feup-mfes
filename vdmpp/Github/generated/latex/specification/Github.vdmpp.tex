\begin{vdmpp}[breaklines=true]
 class Github
 types
  -- Map of String (username) to Account
  public AccountsMap = map Utils`String to Account;
  
 values
 -- TODO Define values here
 
 instance variables
  public accounts: AccountsMap := { |-> };
  
 operations
(*@
\label{Github:13}
@*)
  public Github: () ==> Github
  Github() == (return self)
  post card dom accounts = 0;
  
(*@
\label{addAccount:17}
@*)
  public addAccount: Account ==> ()
  addAccount(acc) == (
   accounts(acc.username) := acc;
  )
  pre acc.username not in set dom accounts
  post accounts(acc.username) = acc;
 
(*@
\label{numAccounts:24}
@*)
  public numAccounts: () ==> nat
  numAccounts() == (return card dom accounts);
  
(*@
\label{getRepositoriesByTags:27}
@*)
  public getRepositoriesByTags: set of Tag | set of Utils`String ==> set of Repository
  getRepositoriesByTags(tags) ==
   return {r | r in set dunion {rng a.repositories | a in set rng accounts} & repoMatchesTags(r, tags)}
  pre tags <> {};
  
  -- Get name of the User accounts
(*@
\label{getUsers:33}
@*)
  private pure getUsers: () ==> set of Utils`String
  getUsers() == return {un | un in set dom accounts & isofclass(User, accounts(un))}  
  post forall un in set RESULT & isofclass(User, accounts(un));

(*@
\label{stargazers:37}
@*)
  public pure stargazers: Repository ==> set of Utils`String
(*@
\label{getAllRepos:38}
@*)
  stargazers(repo) ==
   return {un | un in set getUsers() & repo in set narrow_(accounts(un), User).getStars()}
  post (forall un in set RESULT & repo in set narrow_(accounts(un), User).getStars()) and
   (forall un in set getUsers() \ RESULT & repo not in set narrow_(accounts(un), User).getStars());

  -- Gets sequence containing all Repositories
  private getAllRepos: () ==> seq of Repository
  getAllRepos() == (*@\vdmnotcovered{(}@*)
   dcl reposSet: set of Repository := {}, repos: seq of Repository := (*@\vdmnotcovered{[}@*)];
   (*@\vdmnotcovered{for}@*) all acc in set rng (*@\vdmnotcovered{accounts}@*) do
    reposSet := reposSet union {r | r in set rng acc.repositories \ (*@\vdmnotcovered{reposSet}@*)};
(*@
\label{getTopRepos:49}
@*)
   (*@\vdmnotcovered{for}@*) all r in set reposSet do repos := repos ^ [(*@\vdmnotcovered{r}@*)];
   (*@\vdmnotcovered{return}@*) (*@\vdmnotcovered{repos}@*);
  )
  post forall e in set dunion { rng acc.repositories | acc in set rng accounts } & e in set elems (*@\vdmnotcovered{RESULT}@*) (*@\vdmnotcovered{and}@*)
   card dunion { rng acc.repositories | acc in set rng accounts } = len (*@\vdmnotcovered{RESULT}@*);

  -- Orders Repositories by number of stars using a bubble-sort like algorithm
  public getTopRepos: () ==> seq of Repository
  getTopRepos() == (*@\vdmnotcovered{(}@*)
   dcl l: seq of Repository := (*@\vdmnotcovered{getAllRepos}@*)();
   dcl sorted_list: seq of Repository := (*@\vdmnotcovered{l}@*);
   for i = (*@\vdmnotcovered{len}@*) (*@\vdmnotcovered{l}@*) to (*@\vdmnotcovered{1}@*) by -(*@\vdmnotcovered{1}@*) do
    (*@\vdmnotcovered{for}@*) j = (*@\vdmnotcovered{1}@*) to i(*@\vdmnotcovered{-}@*)(*@\vdmnotcovered{1}@*) do
     if (*@\vdmnotcovered{card}@*) (*@\vdmnotcovered{stargazers}@*)((*@\vdmnotcovered{sorted\_list}@*)((*@\vdmnotcovered{j}@*))) (*@\vdmnotcovered{<}@*) (*@\vdmnotcovered{card}@*) (*@\vdmnotcovered{stargazers}@*)((*@\vdmnotcovered{sorted\_list}@*)(j+(*@\vdmnotcovered{1}@*)))
      then (*@\vdmnotcovered{(}@*)dcl temp: Repository := (*@\vdmnotcovered{sorted\_list}@*)((*@\vdmnotcovered{j}@*));
       sorted_list((*@\vdmnotcovered{j}@*)) := (*@\vdmnotcovered{sorted\_list}@*)((*@\vdmnotcovered{j}@*)(*@\vdmnotcovered{+}@*)(*@\vdmnotcovered{1}@*));
(*@
\label{repoMatchesTags:65}
@*)
       (*@\vdmnotcovered{sorted\_list}@*)(j+(*@\vdmnotcovered{1}@*)) := (*@\vdmnotcovered{temp}@*)
   );
   return (*@\vdmnotcovered{sorted\_list}@*);
  )
  post forall i in set {(*@\vdmnotcovered{1}@*), ..., len (*@\vdmnotcovered{RESULT}@*) - (*@\vdmnotcovered{1}@*)} & (*@\vdmnotcovered{card}@*) (*@\vdmnotcovered{stargazers}@*)((*@\vdmnotcovered{RESULT}@*)((*@\vdmnotcovered{i}@*))) (*@\vdmnotcovered{>=}@*) (*@\vdmnotcovered{card}@*) (*@\vdmnotcovered{stargazers}@*)((*@\vdmnotcovered{RESULT}@*)(i + (*@\vdmnotcovered{1}@*)));

 functions
  public static repoMatchesTags(r: Repository, tags: set of Utils`String | set of Tag) res: bool ==
  forall t in set tags & (if isofclass(Tag, t) then t.name else t) in set {tInner.name | tInner in set r.tags};
  
end Github
\end{vdmpp}
\bigskip
\begin{longtable}{|l|r|r|r|}
\hline
Function or operation & Line & Coverage & Calls \\
\hline
\hline
\hyperref[Github:13]{Github} & 13&100.0\% & 1 \\
\hline
\hyperref[addAccount:17]{addAccount} & 17&100.0\% & 4 \\
\hline
\hyperref[getAllRepos:38]{getAllRepos} & 38&0.0\% & 0 \\
\hline
\hyperref[getRepositoriesByTags:27]{getRepositoriesByTags} & 27&100.0\% & 6 \\
\hline
\hyperref[getTopRepos:49]{getTopRepos} & 49&0.0\% & 0 \\
\hline
\hyperref[getUsers:33]{getUsers} & 33&100.0\% & 6 \\
\hline
\hyperref[numAccounts:24]{numAccounts} & 24&100.0\% & 3 \\
\hline
\hyperref[repoMatchesTags:65]{repoMatchesTags} & 65&100.0\% & 6 \\
\hline
\hyperref[stargazers:37]{stargazers} & 37&100.0\% & 3 \\
\hline
\hline
Github.vdmpp & & 48.8\% & 29 \\
\hline
\end{longtable}

